generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

enum SprintStatus {
  draft
  ready_to_solve
  solved
}

enum UserRole {
  doctor
  planner
}

enum SprintAvailabilitySource {
  doctor_self_service
  planner_override
}

enum RunStatus {
  succeeded
  failed
}

model Sprint {
  id                       String              @id
  name                     String
  periodId                 String
  status                   SprintStatus
  requiredDoctorsPerShift  Int
  maxDaysPerDoctorDefault  Int
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  period                   Period              @relation(fields: [periodId], references: [id], onDelete: Restrict)
  doctors                  SprintDoctor[]
  availabilityEntries      SprintAvailability[]
  runs                     SprintRun[]

  @@map("sprints")
  @@index([periodId], map: "idx_sprints_period_id")
  @@index([status], map: "idx_sprints_status")
}

model SprintDoctor {
  id                    String   @id
  sprintId              String
  doctorId              String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  sprint                Sprint   @relation(fields: [sprintId], references: [id], onDelete: Cascade)
  doctor                Doctor   @relation(fields: [doctorId], references: [id], onDelete: Restrict)

  @@map("sprint_doctors")
  @@unique([sprintId, doctorId], map: "uq_sprint_doctors_sprint_doctor")
  @@index([sprintId], map: "idx_sprint_doctors_sprint_id")
  @@index([doctorId], map: "idx_sprint_doctors_doctor_id")
}

model SprintAvailability {
  id              String                   @id
  sprintId        String
  doctorId        String
  periodId        String
  dayId           String
  source          SprintAvailabilitySource
  updatedByUserId String
  updatedByRole   UserRole
  updatedAt       DateTime
  sprint          Sprint                   @relation(fields: [sprintId], references: [id], onDelete: Cascade)
  doctor          Doctor                   @relation(fields: [doctorId], references: [id], onDelete: Restrict)
  period          Period                   @relation(fields: [periodId], references: [id], onDelete: Restrict)

  @@map("sprint_availability")
  @@unique([sprintId, doctorId, periodId, dayId], map: "uq_sprint_availability_entry")
  @@index([sprintId], map: "idx_sprint_availability_sprint_id")
  @@index([sprintId, doctorId], map: "idx_sprint_availability_sprint_doctor")
  @@index([sprintId, periodId, dayId], map: "idx_sprint_availability_sprint_period_day")
}

model SprintRun {
  id             String   @id
  sprintId       String
  executedAt     DateTime @default(now())
  status         RunStatus
  inputSnapshot  Json
  outputSnapshot Json?
  errorCode      String?
  errorMessage   String?
  sprint         Sprint   @relation(fields: [sprintId], references: [id], onDelete: Cascade)

  @@map("sprint_runs")
  @@index([sprintId, executedAt], map: "idx_sprint_runs_sprint_executed_at")
}

model Doctor {
  id                   String              @id
  name                 String
  active               Boolean
  maxTotalDaysDefault  Int?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  sprintLinks          SprintDoctor[]
  availabilityEntries  SprintAvailability[]

  @@map("doctors")
  @@index([active], map: "idx_doctors_active")
}

model Period {
  id                   String              @id
  name                 String
  startsOn             String
  endsOn               String
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  demands              PeriodDemand[]
  sprints              Sprint[]
  availabilityEntries  SprintAvailability[]

  @@map("periods")
  @@index([startsOn, endsOn], map: "idx_periods_date_range")
}

model PeriodDemand {
  id              String   @id
  periodId        String
  dayId           String
  requiredDoctors Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  period          Period   @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@map("period_demands")
  @@unique([periodId, dayId], map: "uq_period_demands_period_day")
  @@index([periodId], map: "idx_period_demands_period_id")
}
